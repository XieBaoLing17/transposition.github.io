<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        h1 {
            text-align: center;
        }
        
        .btn {
            background-color: DodgerBlue;
            border: none;
            color: white;
            padding: 12px 16px;
            font-size: 16px;
            cursor: pointer;
        }
        /* Darker background on mouse-over */
        
        .btn:hover {
            background-color: RoyalBlue;
        }
        
        div {
            clear: left;
            padding: 0;
            padding-top: 30px;
            cursor: default;
        }
        
        div.white_key {
            clear: none;
            height: 100px;
            width: 38px;
            border: #000 solid 1px;
            background-color: white;
            float: left;
            cursor: pointer;
            position: relative;
        }
        
        div.white_key:hover {
            clear: none;
            height: 100px;
            width: 38px;
            border: #000 solid 1px;
            background-color: rgb(83, 171, 238);
            cursor: pointer;
            background-color: rgb(83, 171, 238);
        }
        
        div.black_key {
            position: absolute;
            height: 50px;
            width: 20px;
            border: #000 solid 1px;
            background-color: black;
            cursor: pointer;
        }
        
        .keyboard {
            text-align: center;
        }
        
        #div_keyboard {
            margin-left: 200px;
        }
        
        .chord {
            text-align: center;
            margin-top: 65px;
        }
        
        .black_chord {
            text-align: center;
            margin-top: 2px;
            color: aliceblue;
        }
        
        div.note_success {
            background-color: greenyellow;
        }
        
        div.note_fail {
            background-color: red;
        }
        
        #note_container {
            height: 100px;
            position: relative;
        }
        
        #note_container p {
            opacity: 0;
            transition: 0.75s ease-in-out;
            position: absolute;
        }
        
        #note_container .main_note {
            opacity: 1;
            font-size: 1.5rem;
            left: 20%;
        }
        
        #note_container .previous_note {
            opacity: 0.5;
            left: 16%;
        }
        
        #note_container .no_note {
            scale: 0;
            opacity: 0;
            left: 10%;
        }
        
        #note_container .next_note {
            opacity: 0.5;
            left: 25%;
        }
        
        #note_container .future_note {
            scale: 0;
            opacity: 0;
            left: 30%;
        }
        
        .success_note_tile {
            height: 100%;
            width: 100%;
            background-color: greenyellow;
            animation: success_note_fly 0.5s ease-in-out;
            position: absolute;
            opacity: 0;
        }
        /* Music Player Part */
        
        @keyframes success_note_fly {
            0% {
                opacity: 0.8;
                top: 0;
            }
            100% {
                transform: translateY(100%);
                top: 150%;
            }
        }
    </style>
    <title>Advanced INC.MUSIC</title>
    <h1>Practice Bach Prelude in C to Different Majors</h1>
    <button class="btn" onclick="document.location='index.html'"><i class="fa fa-home"></i>Home </button>

</head>

<body onload="startMIDI()">
    <!-- Audio Start -->
    <div class="audio">
        <midi-player src="Prelude_C_major.mid" sound-font visualizer="#myVisualizer">
        </midi-player>
    </div>
    <!-- Audio End -->

    <!-- Adjust Tempo Start -->
    <br><br>
    <span class="input">
        <b>Adjust Tempo</b>
        <input id="tempoInput" onchange="changeTempo(event)" value="29" type="range" min="20" max="240" step="1">
        <span id="tempoValue">30</span>
    </span>
    <!-- Adjust Tempo End -->

    <!-- Select Majors Start-->
    <p>
        <label for="chooseKey">Major keys</label><br />
        <select id="chooseKey" onchange="changeMajorKey(value)">
              <option value="C">C major</option>
              <option value="G">G major</option>
              <option value="D">D major</option>
              <option value="A">A major</option>
              <option value="E">E major</option>
              <option value="B">B major</option>
              <option value="F#">F# major</option>
            </select>
    </p>
    <!-- Select Majors End-->

    <p id="log_string"></p>
    <div id="note_container">
        <!-- <p id="note" style="opacity: 1;"></p> -->
    </div>
    <div id="div_keyboard">
        <!-- white keys -->
        <div id="key48" class="white_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)">
            <p class="chord">C</p>
        </div>
        <div id="key50" class="white_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)">
            <p class="chord">D</p>
        </div>
        <div id="key52" class="white_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)">
            <p class="chord">E</p>
        </div>
        <div id="key53" class="white_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)">
            <p class="chord">F</p>
        </div>
        <div id="key55" class="white_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)">
            <p class="chord">G</p>
        </div>
        <div id="key57" class="white_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)">
            <p class="chord">A</p>
        </div>
        <div id="key59" class="white_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)">
            <p class="chord">B</p>
        </div>
        <div id="key60" class="white_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)">
            <p class="chord">C</p>
        </div>
        <div id="key62" class="white_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)">
            <p class="chord">D</p>
        </div>
        <div id="key64" class="white_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)">
            <p class="chord">E</p>
        </div>
        <div id="key65" class="white_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)">
            <p class="chord">F</p>
        </div>
        <div id="key67" class="white_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)">
            <p class="chord">G</p>
        </div>
        <div id="key69" class="white_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)">
            <p class="chord">A</p>
        </div>
        <div id="key71" class="white_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)">
            <p class="chord">B</p>
        </div>
        <div id="key72" class="white_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)">
            <p class="chord">C</p>
        </div>
        <div id="key74" class="white_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)">
            <p class="chord">D</p>
        </div>
        <div id="key76" class="white_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)">
            <p class="chord">E</p>
        </div>
        <div id="key77" class="white_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)">
            <p class="chord">F</p>
        </div>
        <div id="key79" class="white_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)">
            <p class="chord">G</p>
        </div>
        <div id="key81" class="white_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)">
            <p class="chord">A</p>
        </div>
        <div id="key83" class="white_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)">
            <p class="chord">B</p>
        </div>
        <div id="key84" class="white_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)">
            <p class="chord">C</p>
        </div>
        <!-- black keys -->
        <div id="key49" class="black_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)" style="margin-left: 30px">
            <p class="black_chord">C#<br />Db</p>
        </div>
        <div id="key51" class="black_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)" style="margin-left: 70px">
            <p class="black_chord">D#<br />Eb</p>
        </div>
        <div id="key54" class="black_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)" style="margin-left: 150px">
            <p class="black_chord">F#<br />Gb</p>
        </div>
        <div id="key56" class="black_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)" style="margin-left: 190px">
            <p class="black_chord">G#<br />Ab</p>
        </div>
        <div id="key58" class="black_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)" style="margin-left: 230px">
            <p class="black_chord">A#<br />Bb</p>
        </div>

        <div id="key61" class="black_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)" style="margin-left: 310px">
            <p class="black_chord">C#<br />Db</p>
        </div>
        <div id="key63" class="black_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)" style="margin-left: 350px">
            <p class="black_chord">D#<br />Eb</p>
        </div>
        <div id="key66" class="black_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)" style="margin-left: 430px">
            <p class="black_chord">F#<br />Gb</p>
        </div>
        <div id="key68" class="black_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)" style="margin-left: 470px">
            <p class="black_chord">G#<br />Ab</p>
        </div>
        <div id="key70" class="black_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)" style="margin-left: 510px">
            <p class="black_chord">A#<br />Bb</p>
        </div>

        <div id="key73" class="black_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)" style="margin-left: 590px">
            <p class="black_chord">C#<br />Db</p>
        </div>
        <div id="key75" class="black_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)" style="margin-left: 630px">
            <p class="black_chord">D#<br />Eb</p>
        </div>
        <div id="key78" class="black_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)" style="margin-left: 710px">
            <p class="black_chord">F#<br />Gb</p>
        </div>
        <div id="key80" class="black_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)" style="margin-left: 750px">
            <p class="black_chord">G#<br />Ab</p>
        </div>
        <div id="key82" class="black_key" onmousedown="playNote(this)" onmouseup="stopNote(this)" onmouseout="stopNote(this)" style="margin-left: 790px">
            <p class="black_chord">A#<br />Bb</p>
        </div>
    </div>
    <div id="div_options">

        <p>
            <label for="chooseOutput">MIDI Output</label><br />
            <select id="chooseOutput" onchange="changeOutput(value)">
          <option>None</option>
        </select>
        </p>
        <p>
            Instrument<br />
            <input type="radio" name="instrument" id="piano" checked="checked" onclick="changeProgram(0)" />
            <label for="piano">Piano</label>
            <input type="radio" name="instrument" id="harpsichord" onclick="changeProgram(6)" />
            <label for="harpsichord">Harpsichord</label>
            <input type="radio" name="instrument" id="organ" onclick="changeProgram(19)" />
            <label for="organ">Organ</label>
            <input type="radio" name="instrument" id="celesta" onclick="changeProgram(8)" />
            <label for="celesta">Celesta</label>
        </p>

    </div>
</body>

<!-- MIDI PLAYER START-->
<script src="https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.4.0"></script>

<!-- MIDI PLAYER END -->
<script>
    var midi = null;
    var currentOutput = null;
    let song_notes = ["key60", "key64", "key67", "key72", "key76", "key67", "key72", "key76",
        "key60", "key64", "key67", "key72", "key76", "key67", "key72", "key76",
        "key60", "key62", "key69", "key74", "key77", "key69", "key74", "key77",
        "key60", "key62", "key69", "key74", "key77", "key69", "key74", "key77",
        "key59", "key62", "key67", "key74", "key77", "key67", "key74", "key77",
        "key59", "key62", "key67", "key74", "key77", "key67", "key74", "key77",
        "key60", "key64", "key67", "key72", "key76", "key67", "key72", "key76",
        "key60", "key64", "key67", "key72", "key76", "key67", "key72", "key76"
    ];
    let current_notes_index = 0;
    const changeMajorKey = (value) => {
        switch (value) {
            case "C":
                song_notes = ["key60", "key64", "key67", "key72", "key76", "key67", "key72", "key76",
                    "key60", "key64", "key67", "key72", "key76", "key67", "key72", "key76",
                    "key60", "key62", "key69", "key74", "key77", "key69", "key74", "key77",
                    "key60", "key62", "key69", "key74", "key77", "key69", "key74", "key77",
                    "key59", "key62", "key67", "key74", "key77", "key67", "key74", "key77",
                    "key59", "key62", "key67", "key74", "key77", "key67", "key74", "key77",
                    "key60", "key64", "key67", "key72", "key76", "key67", "key72", "key76",
                    "key60", "key64", "key67", "key72", "key76", "key67", "key72", "key76"
                ];
                break;
            case "G":
                song_notes = ["key67", "key71", "key74", "key79", "key83", "key74", "key79", "key83"];
                break;
            case "D":
                song_notes = ["key62", "key66", "key69", "key72", "key76"];
                break;
            case "A":
                song_notes = ["key69", "key61", "key67", "key72", "key76"];
                break;
            case "E":
                song_notes = ["key64", "key68", "key67", "key72", "key76"];
                break;
            case "B":
                song_notes = ["key71", "key63", "key67", "key72", "key76"];
                break;
            case "F#":
                song_notes = ["key65", "key69", "key67", "key72", "key76"];
                break;

            default:
                break;
        }
        current_notes_index = 0;
        document.getElementById("note_container").innerHTML = "";
        song_notes.map((val, index) => {
            const node = document.createElement("p");
            node.setAttribute("id", index)
            const textnode = document.createTextNode(val);
            node.appendChild(textnode);
            document.getElementById("note_container").appendChild(node)
        })
        note_refresh();
    }
    const note_refresh = () => {

        var elements = document.getElementsByClassName("note_success");
        var elementsArray = Array.from(elements);
        elementsArray.forEach(function(element) {
            element.classList.remove("note_success");
        });

        elements = document.getElementsByClassName("note_fail");
        elementsArray = Array.from(elements);
        elementsArray.forEach(function(element) {
            element.classList.remove("note_fail");
        });

        let key = song_notes[current_notes_index];
        // document.getElementById("previous_note").textContent = song_notes[current_notes_index-1] ?? "";
        if (current_notes_index > 1) {
            document.getElementById(current_notes_index - 2).className = " ";
            document.getElementById(current_notes_index - 2).classList.add("no_note");
        }

        if (current_notes_index != 0) {
            document.getElementById(current_notes_index - 1).className = " ";
            document.getElementById(current_notes_index - 1).classList.add("previous_note");
        }

        // document.getElementById("next_note").textContent = song_notes[current_notes_index+1] ?? "";
        if (current_notes_index != (song_notes.length)) {
            document.getElementById(current_notes_index).className = " ";
            document.getElementById(current_notes_index).classList.add("main_note");
        }
        // document.getElementById("note").textContent=key ?? "";
        if (current_notes_index + 1 < song_notes.length) {
            document.getElementById(current_notes_index + 1).className = " ";
            document.getElementById(current_notes_index + 1).classList.add("next_note");
        }
        if (current_notes_index + 2 < song_notes.length) {
            document.getElementById(current_notes_index + 2).className = " ";
            document.getElementById(current_notes_index + 2).classList.add("future_note");
        }
        // document.getElementById(key).classList.add("note_success");
        // document.getElementById("note").innerHTML = key;
        console.log("hi");
    }
    const pressed_key = (event) => {

        let key = String.fromCharCode(event.keyCode);
        let keyid = 0;
        try {
            switch (key) {
                case "P": //B
                    keyid = 59;
                    break;
                case "A": //C4
                    keyid = 60;
                    break;
                case "Q": //C#
                    keyid = 61;
                    break;
                case "S": //D
                    keyid = 62;
                    break;
                case "D": //E
                    keyid = 64;
                    break;
                case "F": //F
                    keyid = 65;
                    break;
                case "G": //G
                    keyid = 67;
                    break;
                case "H": //A
                    keyid = 69;
                    break;
                case "J": //B
                    keyid = 71;
                    break;
                case "K": //C
                    keyid = 72;
                    break;
                case "L": //D
                    keyid = 74;
                    break;
                case "Z": //E
                    keyid = 76;
                    break;
                case "X": //F
                    keyid = 77;
                    break;
                case "Y":
                    keyid = 70;
                    break;
                case "1":
                    keyid = 76;
                    break;
                default:
                    break;
            }
            console.log("key" + keyid)
            document.getElementById("key" + keyid).dispatchEvent(new Event('mousedown'));
        } catch (error) {
            console.log("key" + keyid)
            document.getElementById("key" + keyid).dispatchEvent(new Event('nodefail'));
        }
    }


    function startMIDI() {

        document.addEventListener('keydown', (event) => {
            pressed_key(event);
        })
        song_notes.map((val, index) => {
            const node = document.createElement("p");
            node.setAttribute("id", index)
            const textnode = document.createTextNode(val);
            node.appendChild(textnode);
            document.getElementById("note_container").appendChild(node)
        })
        note_refresh();
        if (navigator.requestMIDIAccess) {
            navigator.requestMIDIAccess().then(onMIDISuccess, onMIDIFailure);
            console.log("MIDI YES")
        } else {
            document.getElementById("div_keyboard").style.display = "none";
            document.getElementById("div_options").style.display = "none";
            document.getElementById("log_string").innerHTML =
                "Your browser does not support the Web MIDI API!";
        }
        // Adjust Tempo Start-1
        const playButton = document.querySelector('midi-player').shadowRoot.querySelector('.play');
        playButton.addEventListener('click', () => {
            const tempo = document.getElementById("tempoInput").value;
            Tone.Transport.bpm.value = tempo;
        });
        // Adjust Tempo End-1
    }

    function onMIDISuccess(midiAccess) {
        document.getElementById("log_string").innerHTML = "Welcome to Use MIDI";
        midi = midiAccess;
        getcurrentOutput();
        changeProgram(0);
    }

    function onMIDIFailure(msg) {
        document.getElementById("log_string").innerHTML =
            "No access to MIDI resources. Error message: " + msg;
    }

    function changeOutput(outputId) {
        currentOutput.send([176, 123, 0]);
        currentOutput = midi.outputs.get(outputId);
    }

    function showAlert() {
        alert("Hello world!");
    }

    function getcurrentOutput() {
        var outputsToString = "";
        midi.outputs.forEach(function(output, key) {
            if (outputsToString == "") {
                outputsToString +=
                    "<option selected='selected' value='" +
                    key +
                    "'>" +
                    output.name +
                    "</option>";
                currentOutput = output;
            } else {
                outputsToString +=
                    "<option value='" + output.id + "'>" + output.name + "</option>";
            }
        });
        document.getElementById("chooseOutput").innerHTML = outputsToString;
    }

    function playNote(senderDiv) {
        var pitch = senderDiv.id.substring(3, 5);
        let key_id = senderDiv.id;
        // let clicked_note = document.getElementById(key_id).querySelector("p.chord").textContent;

        if (key_id === song_notes[current_notes_index]) {
            current_notes_index++;
            let node = document.createElement("div");
            node.classList.add("success_note_tile");
            document.getElementById(key_id).appendChild(node);
            note_refresh();
        } else {
            document.getElementById(senderDiv.id).classList.add("note_fail")
        }
        var noteOnMsg = [0x90, pitch, 96];
        currentOutput.send(noteOnMsg);
        //document.getElementById(senderDiv.id).style.backgroundColor = "pink";
    }

    function stopNote(senderDiv) {
        var pitch = senderDiv.id.substring(3, 5);
        var noteOffMsg = [0x80, pitch, 0];
        currentOutput.send(noteOffMsg);
        if (
            pitch % 12 == 1 ||
            pitch % 12 == 3 ||
            pitch % 12 == 6 ||
            pitch % 12 == 8 ||
            pitch % 12 == 10
        )
            document.getElementById(senderDiv.id).style.backgroundColor = "black";
        //else
        //document.getElementById(senderDiv.id).style.backgroundColor = "ivory";
    }

    function changeProgram(patch) {
        var allNotesOffMsg = [176, 123, 0]; // 176 corrisponde a 0xB0 (Control Change, channel 1, All Notes Off)
        var programChangeMsg = [192, patch]; // 192 corrisponde a 0xC0 (Program Change, channel 1, Program Change)
        currentOutput.send(allNotesOffMsg);
        currentOutput.send(programChangeMsg);
    }

    // Adjust Tempo Start-2
    function changeTempo(event) {
        let tempo = event.target.value;
        Tone.Transport.bpm.value = tempo;
        document.getElementById("tempoValue").innerHTML = tempo;
        document.getElementById("tempoInput").value = tempo;
        document.getElementById("tempoInput").setAttribute('value', tempo);
    }
    // Adjust Tempo End-2
</script>

</html>